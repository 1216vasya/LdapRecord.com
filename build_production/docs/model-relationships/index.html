<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="Implementing and utilizing relationships in LdapRecord">

        <meta property="og:site_name" content="LdapRecord"/>
        <meta property="og:title" content="Model Relationships | LdapRecord"/>
        <meta property="og:description" content="Implementing and utilizing relationships in LdapRecord"/>
        <meta property="og:url" content="https://ldaprecord.com/docs/model-relationships"/>
        <meta property="og:image" content="/assets/img/logo.png"/>
        <meta property="og:type" content="website"/>

        <meta name="twitter:image:alt" content="LdapRecord">
        <meta name="twitter:card" content="summary_large_image">

                    <meta name="generator" content="tighten_jigsaw_doc">
        
        <title>LdapRecord | Model Relationships</title>

        <link rel="home" href="https://ldaprecord.com">
        <link rel="icon" href="/favicon.ico">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="manifest" href="/site.webmanifest">
        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">

        
                    <!-- Insert analytics code here -->
        
        <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,300i,400,400i,700,700i,800,800i" rel="stylesheet">
        <link rel="stylesheet" href="/assets/build/css/main.css?id=e681b863524c66fd1c51">

                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
            </head>

    <body class="flex flex-col justify-between min-h-screen bg-gray-100 text-gray-800 leading-normal font-sans">
        <header class="flex items-center shadow bg-white border-b h-24 mb-8 py-4" role="banner">
            <div class="container flex items-center max-w-8xl mx-auto px-4 lg:px-8">
                <div class="flex items-center">
                    <a href="/" title="LdapRecord home" class="inline-flex items-center">
                        <img class="h-20 md:h-24 mr-3" src="/assets/img/logo.svg" alt="LdapRecord logo" />
                    </a>
                </div>

                <div class="flex flex-1 justify-end items-center text-right md:pl-10">
                                            <button
    title="Start searching"
    type="button"
    class="flex md:hidden bg-gray-100 hover:bg-blue-100 justify-center items-center border border-gray-500 rounded-full focus:outline-none h-10 px-3"
    onclick="searchInput.toggle()"
>
    <img src="/assets/img/magnifying-glass.svg" alt="search icon" class="h-4 w-4 max-w-none">
</button>

<div id="js-search-input" class="docsearch-input__wrapper hidden md:block">
    <label for="search" class="hidden">Search</label>

    <input
        id="docsearch-input"
        class="docsearch-input relative block h-10 transition-fast w-full lg:w-1/2 xl:w-1/3 bg-gray-100 outline-none rounded-full text-gray-700 border border-gray-500 focus:border-blue-400 ml-auto px-4 pb-0"
        name="docsearch"
        type="text"
        placeholder="Search"
    >

    <button
        class="md:hidden absolute pin-t pin-r h-full font-light text-3xl text-blue-500 hover:text-blue-600 focus:outline-none -mt-px"
        onclick="searchInput.toggle()"
    >&times;</button>
</div>

                    
                    <a href="https://github.com/DirectoryTree/LdapRecord" class="hidden sm:inline">
                        <svg class="fill-current text-blue-800 w-8 ml-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>GitHub</title><path d="M10 0a10 10 0 0 0-3.16 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94 0-1.1.39-1.99 1.03-2.69a3.6 3.6 0 0 1 .1-2.64s.84-.27 2.75 1.02a9.58 9.58 0 0 1 5 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69 0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0 0 10 0"></path></svg>
                    </a>
                </div>
            </div>

                <button class="flex justify-center items-center bg-purple-500 border border-purple-500 h-10 mr-4 px-5 rounded-full lg:hidden focus:outline-none"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-white h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-white h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

        </header>

        <main role="main" class="w-full flex-auto">
            <section class="container max-w-8xl mx-auto px-6 md:px-8 py-4">
    <div class="flex flex-col lg:flex-row">
        <nav id="js-nav-menu" class="nav-menu hidden lg:block">
            <ul class="list-none my-0">
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-600 font-bold">Getting Started</p>
    
            
        <ul class="list-none my-0">
            <li class="pl-4">
            
        <a href="/docs/installation"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Installation
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/configuration"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Configuration
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/connections"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Connecting
        </a>
    
    </li>
    </ul>
    </li>
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-600 font-bold">Models</p>
    
            
        <ul class="list-none my-0">
            <li class="pl-4">
            
        <a href="/docs/models"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Getting Started
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/model-relationships"
            class="lvl1  active font-semibold text-blue-500 nav-menu__item hover:text-blue-500"
        >
            Relationships
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/model-mutators"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Accessors &amp; Mutators
        </a>
    
    </li>
    </ul>
    </li>
            <li class="pl-4">
            
        <a href="/docs/searching"
            class="lvl0   nav-menu__item hover:text-blue-500"
        >
            Searching
        </a>
    
            
        <ul class="list-none my-0">
            <li class="pl-4">
            
        <a href="/docs/events"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Events
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/logging"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Logging
        </a>
    
    </li>
    </ul>
    </li>
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-600 font-bold">Tutorials</p>
    
            
        <ul class="list-none my-0">
            <li class="pl-4">
            
        <a href="/docs/tutorials/authentication"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Authentication
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="/docs/tutorials/common-queries"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Common Queries
        </a>
    
    </li>
            <li class="pl-4">
            
        <p class="nav-menu__item text-gray-600 font-bold">ActiveDirectory</p>
    
            
        <ul class="list-none my-0">
            <li class="pl-4">
            
        <a href="/docs/tutorials/user-management"
            class="lvl2   nav-menu__item hover:text-blue-500"
        >
            User Management
        </a>
    
    </li>
    </ul>
    </li>
    </ul>
    </li>
    </ul>
        </nav>

        <div class="DocSearch-content w-full lg:w-3/5 break-words pb-16 lg:pl-4" v-pre>
            <h1>Models: Relationships</h1>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#defining-relationships">Defining Relationships</a>
<ul>
<li><a href="#has-one">Has One</a></li>
<li><a href="#has-many">Has Many</a></li>
<li><a href="#has-many-inverse">Has Many (Inverse)</a></li>
<li><a href="#has-many-in">Has Many In</a></li>
</ul></li>
<li><a href="#querying-relationships">Querying Relationships</a>
<ul>
<li><a href="#recursive-queries">Recursive Queries</a></li>
</ul></li>
<li><a href="#attaching-amp-detatching-relationships">Attaching &amp; Detaching Relationships</a></li>
<li><a href="#checking-relationship-existence">Checking Relationship Existence</a></li>
</ul>
<h2 id="introduction">Introduction</h2>
<p>LDAP records often contain attributes that reference other LDAP records in your directory. An
example of this would be the <code>member</code> attribute on LDAP groups that contain a list of
distinguished names whom are members of the group.</p>
<p>Using LdapRecord relationships, we can define what models contain references to other records
and easily retrieve the referenced models to perform operations upon. There are several
relationship types that LdapRecord supports:</p>
<ul>
<li><a href="#has-one">Has One</a></li>
<li><a href="#has-many">Has Many</a></li>
<li><a href="#has-many-inverse">Has Many (Inverse)</a></li>
<li><a href="#has-many-in">Has Many In</a></li>
</ul>
<h2 id="defining-relationships">Defining Relationships</h2>
<h3 id="has-one">Has One</h3>
<p>A has one relationship is a basic relationship to work with. An example of a &quot;has one&quot; relationship would be
a <code>User</code> having one <code>manager</code>. To define this relationship, we place a <code>manager()</code> method on our <code>User</code>
model, and call the <code>hasOne()</code> method and return the result:</p>
<pre><code class="language-php">&lt;?php

use LdapRecord\Models\Model;

class User extends Model
{
    /**
     * Retrieve the manager of the current user.
     */
    public function manager()
    {
        return $this-&gt;hasOne(User::class, 'manager');
    }
}</code></pre>
<p>The first argument that is passed into the relation is the name of the related model.
The second is the LDAP attribute on the <em>current</em> user that contains the
relationships distinguished name.</p>
<p>If the relationships attribute you are defining does not contain a distinguished name,
you can alter this and define a <em>foreign key</em> using the third parameter. For example,
if our manager attribute actually contains a <code>uid</code>, we can change this so the
related model is retrieved by a UID, instead of a distinguished name:</p>
<pre><code class="language-php">&lt;?php

use LdapRecord\Models\Model;

class User extends Model
{
    /**
     * Retrieve the manager of the current user.
     */
    public function manager()
    {
        return $this-&gt;hasOne(User::class, 'manager', 'uid');
    }
}</code></pre>
<h3 id="has-many">Has Many</h3>
<p>Defining a has many relationship indicates that the model can be apart of
many of the given model.</p>
<p>For example, a <code>User</code> &quot;has many&quot; <code>groups</code>:</p>
<pre><code class="language-php">&lt;?php

use LdapRecord\Models\Model;

class User extends Model
{
    /**
     * Retrieve the groups the user is apart of.
     */
    public function groups()
    {
        return $this-&gt;hasMany(Group::class, 'member');
    }
}</code></pre>
<p>In the above example, LdapRecord will construct a query to locate all of
the groups that the user is apart of using the users distinguished name.
This users distinguished name will automatically be escaped to
be able to properly locate all of the groups.</p>
<p>For example, this is the query filter that will be used in the search:</p>
<pre><code>(member=cn\3dJohn Doe\2cdc\3dacme\2cdc\3dorg)</code></pre>
<p>If you're using an alternate LDAP server or a different attribute to locate
group membership, you may change the relation key. For example, you may
want to use <code>uniquemember</code> for this relationship:</p>
<pre><code class="language-php">/**                                                
 * Retrieve the groups the user is apart of.       
 */                                                
public function groups()                           
{                                                  
    return $this-&gt;hasMany(Group::class, 'uniquemember'); 
}                                                  </code></pre>
<p>You may also define a <em>foreign key</em> in third parameter if the attribute
you are using is not a distinguished name.</p>
<h3 id="has-many-inverse">Has Many (Inverse)</h3>
<p>Now that we have setup a <code>User</code> model that can access of their groups,
lets define a <code>Group</code> model to be able to access its members.</p>
<p>Since an LDAP group can contain various types of objects (such as
contacts, users, and other groups), we must pass in an array of
models that are potential members of the group. This allows
the relationship to properly create the models that are
returned from the query results.</p>
<blockquote>
<p>LdapRecord will return plain <code>Entry</code> models when
it cannot locate the correct model in the given array.</p>
</blockquote>
<pre><code class="language-php">&lt;?php

use LdapRecord\Models\Model;

class Group extends Model
{
    /**
     * Retrieve the members of the group.
     */
    public function members()
    {
        return $this-&gt;hasMany([
            Group::class, User::class, Contact::class
        ], 'memberof')-&gt;using($this, 'member');
    }
}</code></pre>
<blockquote>
<p>For brevity, we have not shown the creation of the <code>Contact</code> model.</p>
</blockquote>
<p>You can see from the above example, we have passed an array of models
that are possible members of the group. The difference of this
definition is the usage of the <code>using()</code> method.</p>
<p>Since LDAP does not offer bi-directional relationships we must add the
<code>using()</code> method. This method defines which model and attribute
to use for attaching and detaching related models.</p>
<p>In this case, we pass in <code>$this</code> to indicate that the current model
instance (the <code>Group</code>) contains the <code>member</code> attribute to add and
remove models you pass into the <code>attach()</code> and <code>detach()</code> methods.</p>
<p>This method is paramount to be able to properly utilize this relationship.</p>
<p>When querying the above relationship, LdapRecord will construct the following filter:</p>
<pre><code>(memberof=cn\3dAccounting\2cdc\3dacme\2cdc\3dorg)</code></pre>
<h3 id="has-many-in">Has Many In</h3>
<p>The has many in relationship allows you to retrieve related models from
the given parent models <a href="https://ldapwiki.com/wiki/Virtual%20Attribute">virtual attribute</a>
such as <code>memberof</code>.</p>
<blockquote>
<p>Since this relationship uses virtual attributes, you cannot
use <code>attach()</code> or <code>detach()</code> methods. This also means that
for each entry that is contained in the virtual attribute,
they will be queried for individually which can be very
resource intensive depending on the group size.</p>
</blockquote>
<p>Lets define a <code>groups()</code> relationship that utilizes the <code>hasManyIn()</code> method:</p>
<pre><code class="language-php">&lt;?php

use LdapRecord\Models\Model;

class User extends Model
{
    public function groups()
    {
        return $this-&gt;hasManyIn(Group::class, 'memberof');
    }
}</code></pre>
<h4>Important Note for Querying</h4>
<p>When using the above relationship from query results, you must ensure
you select the LDAP property you have defined as the <em>foreign key</em>
in the relationship. This attribute contains the values needed to
locate the related models.</p>
<p>For example, the following relationship query below will return no results
because we have explicitly requested attributes besides <code>memberof</code>:</p>
<pre><code class="language-php">// Selecting only the 'cn', and 'sn' attributes:
$user = User::select(['cn', 'sn'])-&gt;find('cn=John Doe,dc=acme,dc=org');

// Returns an empty collection.
$groups = $user-&gt;groups()-&gt;get();</code></pre>
<h2 id="querying-relationships">Querying Relationships</h2>
<p>LdapRecord relationships also serve as <a href="/docs/searching">query builders</a>.
This means you can chain query builder methods onto relationship methods to add
constraints to the relationship query prior to retrieving the results from
your directory.</p>
<p>For example, lets define a <code>User</code> model that can be a member of many groups:</p>
<pre><code class="language-php">&lt;?php

use App\Group;
use LdapRecord\Models\Model;

class User extends Model
{
    /**
     * Retrieve groups that the current user is apart of.
     */
    public function groups()
    {
        return $this-&gt;hasMany(Group::class, 'member');
    }
}</code></pre>
<p>Now, lets retrieve a user's groups, but only return those groups that have a common name starting with 'Admin':</p>
<pre><code class="language-php">$user = User::find('cn=John Doe,dc=acme,dc=org');

$adminGroups = $user-&gt;groups()-&gt;whereStartsWith('cn', 'Admin')-&gt;get();</code></pre>
<blockquote>
<p>By default, querying relations will not include recursive results. More on this below.</p>
</blockquote>
<h3 id="recursive-queries">Recursive Queries</h3>
<p>To request all of the relationships results, such as nested groups in groups, call
the <code>recursive()</code> method, prior to retrieving results via <code>get()</code>:</p>
<pre><code class="language-php">$user = User::find('cn=John Doe,dc=acme,dc=org');

$allGroups = $user-&gt;groups()-&gt;recursive()-&gt;get();</code></pre>
<p>The <code>recursive()</code> method sets a flag on the LdapRecord relationship indicating
you would like recursive results included (groups of groups).</p>
<p>If you're using ActiveDirectory, the LdapRecord will use </p>
<h2 id="attaching-amp-detatching-relationships">Attaching &amp; Detatching Relationships</h2>
<p>Using relationships you define, you can easily attach and detach related models from each other.
For example, you may want to attach a <code>Group</code> to a <code>User</code>, or vice-versa.</p>
<p>Using the above relationship examples, lets walk through this:</p>
<pre><code class="language-php">$user = User::find('cn=John Doe,dc=acme,dc=org');
$group = Group::find('cn=Accounting,dc=acme,dc=org');

// Attaching a group to a user:
$user-&gt;groups()-&gt;attach($user);

// Attaching a user to a group:
$group-&gt;members()-&gt;attach($user);</code></pre>
<p>You may also use the <code>attachMany()</code> method to attach many models at once.</p>
<p>For this example, let's say we have an organizational unit that contains groups all new users must be apart of:</p>
<pre><code class="language-php">$ou = OrganizationalUnit::find('ou=Groups,dc=acme,dc=org');

$groups = Group::in($ou)-&gt;get();

$user = User::find('cn=John Doe,ou=Users,dc=acme,dc=org');

$user-&gt;groups()-&gt;attach($groups);</code></pre>
<p>As you can see above, we took a complex LDAP operation and completed it in just 4 lines of code.</p>
<h2 id="checking-relationship-existence">Checking Relationship Existence</h2>
<p>To check if a model exists inside of a relationship, use the <code>exists()</code> relationship method.</p>
<p>For example, lets determine if a <code>User</code> is a member of a <code>Group</code>:</p>
<pre><code class="language-php">$user = User::find('cn=John Doe,dc=acme,dc=org');
$group = Group::find('cn=Accounting,dc=acme,dc=org');

if ($user-&gt;groups()-&gt;exists($group)) {
    // This user is a member of the 'Accounting' group.
}</code></pre>
<p>This method can be used on <strong>all</strong> relationship types.</p>
<p>For another example, lets determine if a <code>User</code> is a <code>manager</code> of another:</p>
<pre><code class="language-php">$user = User::find('cn=John Doe,dc=acme,dc=org');
$manager = User::find('cn=Jane Doe,dc=acme,dc=org');

if ($user-&gt;manager()-&gt;exists($manager)) {
    // Jane Doe is John Doe's manager.
}</code></pre>
<p>You can also determine if the model has any groups or members by simply calling <code>exists()</code>:</p>
<pre><code class="language-php">$user = User::find('cn=John Doe,dc=acme,dc=org');

if ($user-&gt;manager()-&gt;exists()) {
    // This user has a manager.
}

if ($user-&gt;groups()-&gt;exists()) {
    // This user is a member of at least one group.
}</code></pre>        </div>
    </div>
</section>
        </main>

        <script src="/assets/build/js/main.js?id=5dd822863934b75738db"></script>

        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
            <script type="text/javascript">
            docsearch({
                apiKey: '8d3be67a9c6f04f6d69ff70a96924698',
                indexName: 'ldaprecord',
                inputSelector: '#docsearch-input',
                debug: false // Set debug to true if you want to inspect the dropdown
            });

            const searchInput = {
                toggle() {
                    const menu = document.getElementById('js-search-input');
                    menu.classList.toggle('hidden');
                    menu.classList.toggle('md:block');
                    document.getElementById('docsearch-input').focus();
                },
            }
        </script>
    
        <footer class="bg-white text-center text-sm mt-12 py-4" role="contentinfo">
            <ul class="flex flex-col md:flex-row justify-center list-none">
                <li class="md:mr-2">
                    &copy; <a href="https://github.com/DirectoryTree" title="DirectoryTree GitHub">DirectoryTree</a> 2019.
                </li>

                <li>
                    Built with <a href="http://jigsaw.tighten.co" title="Jigsaw by Tighten">Jigsaw</a>
                    and <a href="https://tailwindcss.com" title="Tailwind CSS, a utility-first CSS framework">Tailwind CSS</a>.
                </li>
            </ul>
        </footer>
    </body>
</html>
